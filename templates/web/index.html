<!DOCTYPE html>
<html>
<head>
    <title>Revue de Presse Techno</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS (via CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.1/css/brands.css">
    <!-- Petit CSS complémentaire (minimal) pour les animations/transitions -->
    <style>
        /* Animations non couvertes par Tailwind */
        li:hover {
            transform: translateY(-2px);
        }
        .back-to-top {
            transition: all 0.3s ease;
        }
        .toc-header h2 {
            transition: all 0.2s ease;
        }
    </style>
    <!-- Sprite SVG (caché) -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        {% for icon in ['bluesky', 'reddit', 'rss', 'linkedin', 'twitter'] %}
            <symbol id="icon-{{ icon }}" viewBox="0 0 24 24">
                {% include "icons/" ~ icon ~ ".svg" %}
            </symbol>
        {% endfor %}
    </svg>
</head>
<body class="font-sans text-gray-800 max-w-3xl mx-auto my-5 px-5 bg-gray-50">
    <header class="mb-8">
        <h1 class="text-3xl text-center text-gray-800 border-b-2 border-blue-500 pb-2.5">
            Revue de veille techno
        </h1>
        <p class="text-xl text-center text-gray-500 pb-5">
            Les dernières actualités
        </p>
    </header>

    <!-- Recherche plein texte (FTS) -->
     {% include 'fragments/_search_banner.html' %}    

    <!-- Filtrage par date -->
     {% include 'fragments/_dates_filters.html' %} 

    <!-- Résultats search fetch AJAX (sera rempli dynamiquement avec le fragmant _search_ajax_results.html) -->
    <div id="results" class="mb-6"></div>

    <div id="top" class="scroll-mt-20"></div> <!-- Offset pour le scroll -->

    <!-- Sommaire (TOC) -->     
    {% with articles=articles %}
        {% include 'fragments/_toc.html' %}
    {% endwith %}

    <!-- Liste des articles -->
    <ul class="list-none p-0">
        <!-- <object data="/static/icons/bluesky.svg" class="w-6 h-6 text-bluesky"></object> -->
        {% for article in articles %}
        <li
            id="article-{{ loop.index }}"
            class="bg-white mb-5 p-5 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"
        >
            <h2 class="text-xl font-bold text-gray-800 mt-0 flex items-center gap-2">
                <div class="flex items-center gap-2">
                    <a href="#top" class="back-to-top text-blue-500 hover:text-blue-700">↑</a>
                    <i class="fas fa-link text-blue-500"></i>
                    <a href="{{ article.link }}" target="_blank" class="hover:text-blue-700">
                        {{ article.title | truncate(50) | safe}}
                    </a>
                </div>
                <div class="ml-auto">
                    {% with article=article, email=false%}
                        {% include 'fragments/_icon_brand.html' %}
                    {% endwith %}                    
                </div>
            </h2>
            <h3 class="m-0">
                <small class="text-gray-500 block my-2">
                    article publié le {{ article.published | format_date }} -
                    résumé du {{ article.dt_created | format_local_datetime }} -
                    score: {{ article.score }} %
                </small>
            </h3>
            <p class="article-summary text-gray-700 mt-2.5 pl-6 relative">
                <i class="fas fa-newspaper text-blue-500 absolute left-0"></i>
                {{ article.summary | nl2br }}
            </p>
        </li>
        {% endfor %}
    </ul>

    <footer class="mt-10 text-center text-gray-500">
        <p>© 2025 - Veille Techno RSS</p>
    </footer>

    <script>
        // Affiche on/off le sommaine
        function toggleTOC() {
            const toc = document.getElementById('toc-list');
            const header = document.querySelector('.toc-header h2');
            if (toc.classList.contains('hidden')) {
                toc.classList.remove('hidden');
                header.textContent = 'Sommaire ▼';
            } else {
                toc.classList.add('hidden');
                header.textContent = 'Sommaire ▶';
            }
        }

        function _setResponses(data) {
            document.getElementById('results').innerHTML = data;
        }
        // Recherche AJAX par fetch
        document.querySelector('form[action="/search"]').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            formData.append('ajax', 'true');

            const response = await fetch(`/search?${new URLSearchParams(formData)}`);
            if (response.ok) {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (data.error) {                        
                        _setResponses(data.error);                        
                    } else {
                        _setResponses(await response.text());                        
                    }
                } else {
                    _setResponses(await response.text());                    
                }
            } else {
                console.error('Erreur lors de la recherche');
            }
        });
    </script>
</body>
</html>
