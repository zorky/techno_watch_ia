<!DOCTYPE html>
<html>
<head>
    <title>Revue de Presse Techno</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS (via CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Petit CSS complémentaire (minimal) pour les animations/transitions -->
    <style>
        /* Animations non couvertes par Tailwind */
        li:hover {
            transform: translateY(-2px);
        }
        .back-to-top {
            transition: all 0.3s ease;
        }
        .toc-header h2 {
            transition: all 0.2s ease;
        }
    </style>
</head>
<body class="font-sans text-gray-800 max-w-2xl mx-auto my-5 px-5 bg-gray-50">
    <header class="mb-8">
        <h1 class="text-3xl text-center text-gray-800 border-b-2 border-blue-500 pb-2.5">
            Revue de veille techno
        </h1>
        <p class="text-xl text-center text-gray-500 pb-5">
            Les dernières actualités
        </p>
    </header>

    <!-- Recherche plein texte (FTS) -->
    <form method="get" action="/search" class="mb-7">
        <div class="flex flex-wrap gap-2.5 items-end">
            <input
                type="text"
                name="q"
                placeholder="Rechercher dans les articles..."
                class="flex-grow px-3.5 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                value="{{ request.query_params.q if request.query_params.q else '' }}"
            >
            <input
                type="date"
                name="date_min"
                class="px-3.5 py-2 border border-gray-300 rounded-md"
                value="{{ request.query_params.date_min if request.query_params.date_min else '' }}"
            >
            <input
                type="date"
                name="date_max"
                class="px-3.5 py-2 border border-gray-300 rounded-md"
                value="{{ request.query_params.date_max if request.query_params.date_max else '' }}"
            >
            <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
                Rechercher
            </button>
        </div>
    </form>

    <!-- Filtrage par date -->
    <form method="get" class="mb-7 flex flex-wrap gap-2.5 items-center">
        <label for="date" class="font-medium">Filtrer par date de publication :</label>
        <input type="date" id="date" name="date" class="px-3.5 py-2 border border-gray-300 rounded-md">
        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors flex items-center gap-2">
            <i class="fas fa-filter"></i> Filtrer
        </button>
    </form>

    <div id="top" class="scroll-mt-20"></div> <!-- Offset pour le scroll -->

    <!-- Sommaire (TOC) -->
    <div class="bg-white p-2 mb-4 rounded-lg shadow-sm">
        <div class="toc-header cursor-pointer flex items-center" onclick="toggleTOC()">
            <h2 class="text-lg text-gray-800 m-0 font-semibold">Sommaire ▶</h2>
        </div>
        <ol id="toc-list" class="table-of-contents pl-5 hidden"> <!-- Masqué par défaut -->
            {% for article in articles %}
            <li class="my-1.5 py-0.5">
                <a href="#article-{{ loop.index }}" class="text-blue-500 hover:text-blue-600 hover:underline text-sm block">
                    {{ article.title }} ({{ article.published | format_date }})
                </a>
            </li>
            {% endfor %}
        </ol>
    </div>

    <!-- Résultats AJAX (sera rempli dynamiquement) -->
    <div id="results" class="mb-6"></div>

    <!-- Liste des articles -->
    <ul class="list-none p-0">
        {% for article in articles %}
        <li
            id="article-{{ loop.index }}"
            class="bg-white mb-5 p-5 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"
        >
            <h2 class="text-xl font-bold text-gray-800 mt-0 flex items-center gap-2">
                <a href="#top" class="back-to-top text-blue-500 hover:text-blue-700">↑</a>
                <i class="fas fa-link text-blue-500"></i>
                <a href="{{ article.link }}" target="_blank" class="hover:text-blue-700">
                    {{ article.title }}
                </a>
            </h2>
            <h3 class="m-0">
                <small class="text-gray-500 block my-2">
                    article publié le {{ article.published | format_date }} -
                    résumé du {{ article.dt_created | format_local_datetime }} -
                    score: {{ article.score }}
                </small>
            </h3>
            <p class="article-summary text-gray-700 mt-2.5 pl-6 relative">
                <i class="fas fa-newspaper text-blue-500 absolute left-0"></i>
                {{ article.summary | nl2br | safe }}
            </p>
        </li>
        {% endfor %}
    </ul>

    <footer class="mt-10 text-center text-gray-500">
        <p>© 2025 - Veille Techno RSS</p>
    </footer>

    <script>
        function toggleTOC() {
            const toc = document.getElementById('toc-list');
            const header = document.querySelector('.toc-header h2');
            if (toc.classList.contains('hidden')) {
                toc.classList.remove('hidden');
                header.textContent = 'Sommaire ▼';
            } else {
                toc.classList.add('hidden');
                header.textContent = 'Sommaire ▶';
            }
        }

        // Recherche AJAX
        document.querySelector('form[action="/search"]').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            formData.append('ajax', 'true');

            const response = await fetch(`/search?${new URLSearchParams(formData)}`);
            if (response.ok) {
                document.getElementById('results').innerHTML = await response.text();
            } else {
                console.error('Erreur lors de la recherche');
            }
        });
    </script>
</body>
</html>
